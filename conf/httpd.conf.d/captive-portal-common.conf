# Apache configuration
# This file is manipulated on PacketFence's startup before being given to Apache

# Aliases
%%aliases%%

# Access control
# Restrict everything except networks defined in pf's configuration (except other Location exception below)
<DirectoryMatch "%%install_dir%%/html/captive-portal">
  <IfVersion < 2.4>
    Order deny,allow
    Deny from all
    allow from %%routed-nets%% %%load_balancers%% 127.0.0.1
  </IfVersion>
  <IfVersion >= 2.4>
    Require all denied
    Require ip %%routed-nets%%
#    Require ip %%load_balancers%%
    Require local
  </IfVersion>
  <Files "register-gaming-device.cgi">
  <IfVersion < 2.4>
    Allow from all
  </IfVersion>
  <IfVersion >= 2.4>
    Require all granted
  </IfVersion>
  </Files>
</DirectoryMatch>

# Allowed from everywhere
# allowed_from_all_URLs is generated by lib/pf/services/apache.pm (and comes
# with a | first but not after). It is built depending on the features activated.
# /signup and /preregister open only if pre-registration
# /activate/email on sponsor and email guest modes 
<Location ~ "/content/%%allowed_from_all_urls%%">
  <IfVersion < 2.4>
    Allow from all
  </IfVersion>
  <IfVersion >= 2.4>
    Require all granted
  </IfVersion>
</Location>

# Perl config
PerlPostConfigRequire %%install_dir%%/lib/pf/web/captiveportal_modperl_require.pl

# mod_perl handlers are virtually assigned to /perl/
PerlModule pf::web::dispatcher
# The TransHandler handles the 'captive-portal' core piece redirecting to the
# portal if the URL is not otherwised allowed by passthrough or part of the
# portal itself.
PerlTransHandler pf::web::dispatcher::custom
<Location ~ "/perl/release">
  SetHandler modperl
  PerlResponseHandler pf::web::release
  PerlOptions +GlobalRequest +ParseHeaders
</Location>

# Old school CGI's are virtually assigned to /cgi-perl/
Alias /cgi-perl/ "%%install_dir%%/html/captive-portal/"
<Location /cgi-perl>
  SetHandler perl-script
  PerlResponseHandler ModPerl::PerlRun
  PerlOptions +ParseHeaders
</Location>

RewriteEngine On
#RewriteLogLevel 3
#RewriteLog %%install_dir%%/logs/rewrite_log
